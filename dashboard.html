<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Gesti√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #00008f 0%, #0047ab 100%);
            min-height: 100vh;
        }
        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { color: #00008f; font-size: 22px; }
        .header button {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .toolbar {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .toolbar button {
            padding: 10px 20px;
            background: #00008f;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .toolbar button:hover { background: #00005f; }
        .toolbar input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            flex: 1;
            min-width: 200px;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        thead {
            background: #00008f;
            color: white;
        }
        th, td {
            padding: 12px;
            text-align: left;
        }
        tbody tr {
            border-bottom: 1px solid #ddd;
        }
        tbody tr:hover {
            background: #f5f5f5;
        }
        .btn-edit {
            padding: 5px 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
        }
        .btn-delete {
            padding: 5px 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal h2 { color: #00008f; margin-bottom: 20px; }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .span-2 { grid-column: span 2; }
        .modal-footer {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .modal-footer button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-save {
            background: #00008f;
            color: white;
        }
        .btn-cancel {
            background: #6c757d;
            color: white;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 5px;
            color: white;
            display: none;
            z-index: 9999;
        }
        .notification.show { display: block; }
        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .span-2 { grid-column: span 1; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Sistema de Gesti√≥n de Clientes</h1>
        <button onclick="logout()">Cerrar Sesi√≥n</button>
    </div>

    <div class="content">
        <div class="toolbar">
            <button onclick="showModal()">+ Nuevo Cliente</button>
            <button onclick="exportExcel()">‚¨á Exportar Excel</button>
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" onchange="importExcel(event)">
            <button onclick="document.getElementById('fileInput').click()">‚¨Ü Importar Excel</button>
            <input type="text" id="search" placeholder="Buscar..." onkeyup="filterTable()">
        </div>

        <div class="table-container">
            <table id="table">
                <thead>
                    <tr>
                        <th>N¬∞ Cliente</th>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>DNI</th>
                        <th>Poblaci√≥n</th>
                        <th>N¬∞ P√≥liza</th>
                        <th>Estado</th>
                        <th>Aseguradora</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                    <tr><td colspan="9" style="text-align:center; padding:40px;">Cargando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Nuevo Cliente</h2>
            <form id="form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>N¬∞ Cliente *</label>
                        <input type="text" id="n_cliente" required>
                    </div>
                    <div class="form-group">
                        <label>Nombre *</label>
                        <input type="text" id="nombre" required>
                    </div>
                    <div class="form-group">
                        <label>Apellido *</label>
                        <input type="text" id="apellido" required>
                    </div>
                    <div class="form-group">
                        <label>DNI *</label>
                        <input type="text" id="dni" required>
                    </div>
                    <div class="form-group span-2">
                        <label>Direcci√≥n</label>
                        <input type="text" id="direccion">
                    </div>
                    <div class="form-group">
                        <label>C√≥digo Postal</label>
                        <input type="text" id="codigo_postal">
                    </div>
                    <div class="form-group">
                        <label>Poblaci√≥n</label>
                        <input type="text" id="poblacion">
                    </div>
                    <div class="form-group">
                        <label>Fecha Nacimiento</label>
                        <input type="date" id="fecha_nacimiento">
                    </div>
                    <div class="form-group">
                        <label>Fecha Carnet</label>
                        <input type="date" id="fecha_carnet_conducir">
                    </div>
                    <div class="form-group">
                        <label>NIF/CIF</label>
                        <input type="text" id="nif_cif">
                    </div>
                    <div class="form-group">
                        <label>N¬∞ P√≥liza</label>
                        <input type="text" id="n_poliza">
                    </div>
                    <div class="form-group">
                        <label>Estado P√≥liza</label>
                        <select id="estado_poliza">
                            <option value="">Seleccionar...</option>
                            <option value="Activa">Activa</option>
                            <option value="Suspendida">Suspendida</option>
                            <option value="Cancelada">Cancelada</option>
                            <option value="Pendiente">Pendiente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha Baja</label>
                        <input type="date" id="fecha_baja">
                    </div>
                    <div class="form-group">
                        <label>Aseguradora</label>
                        <input type="text" id="aseguradora">
                    </div>
                    <div class="form-group">
                        <label>Fecha Efecto</label>
                        <input type="date" id="fecha_efecto">
                    </div>
                    <div class="form-group">
                        <label>Importe (‚Ç¨)</label>
                        <input type="number" step="0.01" id="importe_recibo">
                    </div>
                    <div class="form-group">
                        <label>Comisi√≥n (‚Ç¨)</label>
                        <input type="number" step="0.01" id="comision">
                    </div>
                    <div class="form-group">
                        <label>Forma Pago</label>
                        <select id="forma_pago">
                            <option value="">Seleccionar...</option>
                            <option value="Domiciliaci√≥n">Domiciliaci√≥n</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Tarjeta">Tarjeta</option>
                            <option value="Efectivo">Efectivo</option>
                        </select>
                    </div>
                    <div class="form-group span-2">
                        <label>IBAN</label>
                        <input type="text" id="n_cuenta">
                    </div>
                    <div class="form-group">
                        <label>Riesgo</label>
                        <select id="riesgo">
                            <option value="">Seleccionar...</option>
                            <option value="Coche">Coche</option>
                            <option value="Moto">Moto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Matr√≠cula</label>
                        <input type="text" id="matricula">
                    </div>
                    <div class="form-group span-2">
                        <label>Comentarios</label>
                        <textarea id="comentarios" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn-save">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // ‚ö†Ô∏è CAMBIAR ESTAS CREDENCIALES
        const SUPABASE_URL = 'https://tu-proyecto.supabase.co';
        const SUPABASE_KEY = 'tu-clave-anonima-aqui';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null;
        let editingId = null;
        let allClients = [];

        // VERIFICAR AUTH
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = session.user;
            loadClients();
        });

        // CARGAR CLIENTES
        async function loadClients() {
            try {
                const { data, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .order('n_cliente', { ascending: true });

                if (error) throw error;

                allClients = data;
                displayClients(data);
            } catch (e) {
                showNotification('Error al cargar clientes', 'error');
                document.getElementById('tbody').innerHTML = '<tr><td colspan="9" style="text-align:center; color:red;">Error al cargar</td></tr>';
            }
        }

        // MOSTRAR CLIENTES
        function displayClients(clients) {
            const tbody = document.getElementById('tbody');
            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">No hay clientes</td></tr>';
                return;
            }

            tbody.innerHTML = clients.map(c => `
                <tr>
                    <td>${c.n_cliente}</td>
                    <td>${c.nombre}</td>
                    <td>${c.apellido}</td>
                    <td>${c.dni}</td>
                    <td>${c.poblacion || '-'}</td>
                    <td>${c.n_poliza || '-'}</td>
                    <td>${c.estado_poliza || '-'}</td>
                    <td>${c.aseguradora || '-'}</td>
                    <td>
                        <button class="btn-edit" onclick="editClient('${c.id}')">‚úèÔ∏è</button>
                        <button class="btn-delete" onclick="deleteClient('${c.id}', '${c.n_cliente}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        // FILTRAR
        function filterTable() {
            const search = document.getElementById('search').value.toLowerCase();
            const filtered = allClients.filter(c => 
                (c.n_cliente || '').toLowerCase().includes(search) ||
                (c.nombre || '').toLowerCase().includes(search) ||
                (c.apellido || '').toLowerCase().includes(search) ||
                (c.dni || '').toLowerCase().includes(search) ||
                (c.poblacion || '').toLowerCase().includes(search)
            );
            displayClients(filtered);
        }

        // MODAL
        function showModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Nuevo Cliente';
            document.getElementById('form').reset();
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
            editingId = null;
        }

        // EDITAR
        async function editClient(id) {
            try {
                const { data, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                editingId = id;
                document.getElementById('modalTitle').textContent = 'Editar Cliente';

                ['n_cliente', 'nombre', 'apellido', 'dni', 'direccion', 'codigo_postal', 
                 'poblacion', 'fecha_nacimiento', 'fecha_carnet_conducir', 'nif_cif', 
                 'n_poliza', 'estado_poliza', 'fecha_baja', 'aseguradora', 'fecha_efecto',
                 'importe_recibo', 'comision', 'forma_pago', 'n_cuenta', 'riesgo', 
                 'matricula', 'comentarios'].forEach(field => {
                    const el = document.getElementById(field);
                    if (el) el.value = data[field] || '';
                });

                document.getElementById('modal').classList.add('show');
            } catch (e) {
                showNotification('Error al cargar', 'error');
            }
        }

        // GUARDAR
        document.getElementById('form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const getData = (id) => {
                const el = document.getElementById(id);
                return el ? el.value.trim() : '';
            };

            const clientData = {
                n_cliente: getData('n_cliente'),
                nombre: getData('nombre'),
                apellido: getData('apellido'),
                dni: getData('dni'),
                direccion: getData('direccion'),
                codigo_postal: getData('codigo_postal'),
                poblacion: getData('poblacion'),
                fecha_nacimiento: getData('fecha_nacimiento') || null,
                fecha_carnet_conducir: getData('fecha_carnet_conducir') || null,
                nif_cif: getData('nif_cif'),
                n_poliza: getData('n_poliza'),
                estado_poliza: getData('estado_poliza'),
                fecha_baja: getData('fecha_baja') || null,
                aseguradora: getData('aseguradora'),
                fecha_efecto: getData('fecha_efecto') || null,
                importe_recibo: parseFloat(getData('importe_recibo')) || null,
                comision: parseFloat(getData('comision')) || null,
                forma_pago: getData('forma_pago'),
                n_cuenta: getData('n_cuenta'),
                riesgo: getData('riesgo'),
                matricula: getData('matricula').toUpperCase(),
                comentarios: getData('comentarios'),
                user_id: currentUser.id
            };

            try {
                let result;
                if (editingId) {
                    result = await supabase.from('clientes').update(clientData).eq('id', editingId);
                } else {
                    result = await supabase.from('clientes').insert([clientData]);
                }

                if (result.error) throw result.error;

                showNotification(editingId ? 'Cliente actualizado' : 'Cliente creado', 'success');
                closeModal();
                loadClients();
            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
            }
        });

        // ELIMINAR
        async function deleteClient(id, num) {
            if (!confirm(`¬øEliminar cliente ${num}?`)) return;

            try {
                const { error } = await supabase.from('clientes').delete().eq('id', id);
                if (error) throw error;
                showNotification('Cliente eliminado', 'success');
                loadClients();
            } catch (e) {
                showNotification('Error al eliminar', 'error');
            }
        }

        // EXPORTAR
        function exportExcel() {
            if (allClients.length === 0) {
                showNotification('No hay datos', 'error');
                return;
            }

            const data = allClients.map(c => ({
                'N Cliente': c.n_cliente,
                'Nombre': c.nombre,
                'Apellido': c.apellido,
                'DNI': c.dni,
                'Direcci√≥n': c.direccion,
                'C√≥digo Postal': c.codigo_postal,
                'Poblaci√≥n': c.poblacion,
                'Fecha Nacimiento': c.fecha_nacimiento,
                'Fecha Carnet': c.fecha_carnet_conducir,
                'NIF/CIF': c.nif_cif,
                'N P√≥liza': c.n_poliza,
                'Estado': c.estado_poliza,
                'Fecha Baja': c.fecha_baja,
                'Aseguradora': c.aseguradora,
                'Fecha Efecto': c.fecha_efecto,
                'Importe': c.importe_recibo,
                'Comisi√≥n': c.comision,
                'Forma Pago': c.forma_pago,
                'IBAN': c.n_cuenta,
                'Riesgo': c.riesgo,
                'Matr√≠cula': c.matricula,
                'Comentarios': c.comentarios
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Clientes');
            XLSX.writeFile(wb, `clientes_${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification('Excel exportado', 'success');
        }

        // IMPORTAR
        async function importExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                    let count = 0;
                    for (const row of jsonData) {
                        const clientData = {
                            n_cliente: (row['N Cliente'] || '').toString(),
                            nombre: (row['Nombre'] || '').toString(),
                            apellido: (row['Apellido'] || '').toString(),
                            dni: (row['DNI'] || '').toString(),
                            direccion: (row['Direcci√≥n'] || '').toString(),
                            codigo_postal: (row['C√≥digo Postal'] || '').toString(),
                            poblacion: (row['Poblaci√≥n'] || '').toString(),
                            fecha_nacimiento: row['Fecha Nacimiento'] || null,
                            fecha_carnet_conducir: row['Fecha Carnet'] || null,
                            nif_cif: (row['NIF/CIF'] || '').toString(),
                            n_poliza: (row['N P√≥liza'] || '').toString(),
                            estado_poliza: row['Estado'] || '',
                            fecha_baja: row['Fecha Baja'] || null,
                            aseguradora: (row['Aseguradora'] || '').toString(),
                            fecha_efecto: row['Fecha Efecto'] || null,
                            importe_recibo: parseFloat(row['Importe'] || 0) || null,
                            comision: parseFloat(row['Comisi√≥n'] || 0) || null,
                            forma_pago: row['Forma Pago'] || '',
                            n_cuenta: (row['IBAN'] || '').toString(),
                            riesgo: row['Riesgo'] || '',
                            matricula: (row['Matr√≠cula'] || '').toString(),
                            comentarios: (row['Comentarios'] || '').toString(),
                            user_id: currentUser.id
                        };

                        if (clientData.n_cliente) {
                            await supabase.from('clientes').insert([clientData]);
                            count++;
                        }
                    }

                    showNotification(`${count} clientes importados`, 'success');
                    loadClients();
                } catch (e) {
                    showNotification('Error al importar', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        // LOGOUT
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }

        // NOTIFICACI√ìN
        function showNotification(msg, type) {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.className = `notification ${type} show`;
            setTimeout(() => notif.classList.remove('show'), 3000);
        }

        // CERRAR MODAL AL CLICK FUERA
        window.onclick = (e) => {
            if (e.target.id === 'modal') closeModal();
        };
    </script>
</body>
</html>