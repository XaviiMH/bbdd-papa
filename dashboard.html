<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Gesti√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --axa-blue: #00008f;
            --axa-light-blue: #0047ab;
            --axa-sky-blue: #4da6ff;
            --axa-dark-blue: #00005f;
            --white: #ffffff;
            --light-gray: #f5f7fa;
            --medium-gray: #e0e6ed;
            --dark-gray: #4a5568;
            --success: #28a745;
            --danger: #dc3545;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--axa-blue) 0%, var(--axa-light-blue) 100%);
            min-height: 100vh;
            color: var(--dark-gray);
        }

        .header {
            background: var(--white);
            padding: 20px 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 { color: var(--axa-blue); font-size: 24px; }

        .header-actions { display: flex; align-items: center; gap: 20px; }
        .user-info { color: var(--dark-gray); font-weight: 500; }

        .main-content { padding: 30px 40px; }

        .toolbar {
            background: var(--white);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar input[type="text"] {
            flex: 1;
            min-width: 250px;
            padding: 10px 15px;
            border: 2px solid var(--medium-gray);
            border-radius: 6px;
            font-size: 15px;
        }

        .toolbar input[type="text"]:focus {
            outline: none;
            border-color: var(--axa-blue);
        }

        .file-input-wrapper { position: relative; overflow: hidden; }
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .btn-primary, .btn-secondary {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--axa-blue);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--axa-dark-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 143, 0.3);
        }

        .btn-secondary {
            background: var(--medium-gray);
            color: var(--dark-gray);
        }

        .btn-secondary:hover {
            background: var(--dark-gray);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-edit {
            background: var(--axa-sky-blue);
            color: var(--white);
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
        }

        .table-container {
            background: var(--white);
            border-radius: 8px;
            overflow-x: auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        thead { background: var(--axa-blue); color: var(--white); }
        thead th { padding: 15px; text-align: left; font-weight: 600; }
        tbody tr { border-bottom: 1px solid var(--medium-gray); transition: background 0.3s; }
        tbody tr:hover { background: var(--light-gray); }
        tbody td { padding: 12px 15px; }

        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 500; }
        .status-active { background: #d4edda; color: #155724; }
        .status-suspendida { background: #fff3cd; color: #856404; }
        .status-cancelada { background: #f8d7da; color: #721c24; }
        .status-pendiente { background: #d1ecf1; color: #0c5460; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .modal.active { display: block; }

        .modal-content {
            background: var(--white);
            margin: 50px auto;
            border-radius: 12px;
            max-width: 900px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 2px solid var(--medium-gray);
        }

        .modal-header h2 { color: var(--axa-blue); font-size: 24px; }

        .close-btn {
            background: none;
            border: none;
            font-size: 32px;
            color: var(--dark-gray);
            cursor: pointer;
            line-height: 1;
        }

        .close-btn:hover { color: var(--danger); }

        .modal form { padding: 30px; }

        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-gray);
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--medium-gray);
            border-radius: 6px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--axa-blue);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .span-2 { grid-column: span 2; }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding-top: 20px;
            border-top: 2px solid var(--medium-gray);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 6px;
            color: var(--white);
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .notification.show { display: block; }
        .notification.success { background: var(--success); }
        .notification.error { background: var(--danger); }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .loading-overlay.show { display: flex; }

        .spinner {
            border: 4px solid var(--light-gray);
            border-top: 4px solid var(--axa-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .span-2 { grid-column: span 1; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .toolbar input[type="text"] { min-width: 100%; }
            .header { flex-direction: column; gap: 15px; padding: 15px 20px; }
            .main-content { padding: 15px 20px; }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <header class="header">
        <h1>üîê Sistema de Gesti√≥n de Clientes</h1>
        <div class="header-actions">
            <span id="userEmail" class="user-info"></span>
            <button onclick="logout()" class="btn-secondary">Cerrar Sesi√≥n</button>
        </div>
    </header>

    <main class="main-content">
        <div class="toolbar">
            <button onclick="showAddClientModal()" class="btn-primary">
                <span>+</span> Nuevo Cliente
            </button>
            <button onclick="exportToExcel()" class="btn-secondary">
                <span>‚¨á</span> Exportar Excel
            </button>
            <div class="file-input-wrapper">
                <button class="btn-secondary">
                    <span>‚¨Ü</span> Importar Excel
                </button>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" onchange="importFromExcel(event)">
            </div>
            <input type="text" id="searchInput" placeholder="Buscar..." onkeyup="filterClients()">
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>N¬∞ Cliente</th>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>DNI</th>
                        <th>Poblaci√≥n</th>
                        <th>N¬∞ P√≥liza</th>
                        <th>Estado</th>
                        <th>Aseguradora</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="clientsTableBody">
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px;">Cargando...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <div id="clientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nuevo Cliente</h2>
                <button class="close-btn" onclick="closeClientModal()">&times;</button>
            </div>
            <form id="clientForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nCliente">N¬∞ Cliente *</label>
                        <input type="text" id="nCliente" required>
                    </div>
                    <div class="form-group">
                        <label for="nombre">Nombre *</label>
                        <input type="text" id="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="apellido">Apellido *</label>
                        <input type="text" id="apellido" required>
                    </div>
                    <div class="form-group">
                        <label for="dni">DNI * üîí</label>
                        <input type="text" id="dni" required>
                    </div>
                    <div class="form-group span-2">
                        <label for="direccion">Direcci√≥n</label>
                        <input type="text" id="direccion">
                    </div>
                    <div class="form-group">
                        <label for="codigoPostal">C√≥digo Postal</label>
                        <input type="text" id="codigoPostal">
                    </div>
                    <div class="form-group">
                        <label for="poblacion">Poblaci√≥n</label>
                        <input type="text" id="poblacion">
                    </div>
                    <div class="form-group">
                        <label for="fechaNacimiento">Fecha Nacimiento</label>
                        <input type="date" id="fechaNacimiento">
                    </div>
                    <div class="form-group">
                        <label for="fechaCarnet">Fecha Carnet</label>
                        <input type="date" id="fechaCarnet">
                    </div>
                    <div class="form-group">
                        <label for="nifCif">NIF/CIF üîí</label>
                        <input type="text" id="nifCif">
                    </div>
                    <div class="form-group">
                        <label for="nPoliza">N¬∞ P√≥liza</label>
                        <input type="text" id="nPoliza">
                    </div>
                    <div class="form-group">
                        <label for="estadoPoliza">Estado P√≥liza</label>
                        <select id="estadoPoliza">
                            <option value="">Seleccionar...</option>
                            <option value="Activa">Activa</option>
                            <option value="Suspendida">Suspendida</option>
                            <option value="Cancelada">Cancelada</option>
                            <option value="Pendiente">Pendiente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fechaBaja">Fecha Baja</label>
                        <input type="date" id="fechaBaja">
                    </div>
                    <div class="form-group">
                        <label for="aseguradora">Aseguradora</label>
                        <input type="text" id="aseguradora">
                    </div>
                    <div class="form-group">
                        <label for="fechaEfecto">Fecha Efecto</label>
                        <input type="date" id="fechaEfecto">
                    </div>
                    <div class="form-group">
                        <label for="importeRecibo">Importe (‚Ç¨)</label>
                        <input type="number" step="0.01" id="importeRecibo">
                    </div>
                    <div class="form-group">
                        <label for="comision">Comisi√≥n (‚Ç¨)</label>
                        <input type="number" step="0.01" id="comision">
                    </div>
                    <div class="form-group">
                        <label for="formaPago">Forma Pago</label>
                        <select id="formaPago">
                            <option value="">Seleccionar...</option>
                            <option value="Domiciliaci√≥n">Domiciliaci√≥n</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Tarjeta">Tarjeta</option>
                            <option value="Efectivo">Efectivo</option>
                        </select>
                    </div>
                    <div class="form-group span-2">
                        <label for="nCuenta">IBAN üîí</label>
                        <input type="text" id="nCuenta" placeholder="ES00 0000 0000 00 0000000000">
                    </div>
                    <div class="form-group">
                        <label for="riesgo">Riesgo</label>
                        <select id="riesgo">
                            <option value="">Seleccionar...</option>
                            <option value="Coche">Coche</option>
                            <option value="Moto">Moto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="matricula">Matr√≠cula</label>
                        <input type="text" id="matricula">
                    </div>
                    <div class="form-group span-2">
                        <label for="comentarios">Comentarios üîí</label>
                        <textarea id="comentarios" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeClientModal()" class="btn-secondary">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // ==================== CONFIGURACI√ìN ====================
        const SUPABASE_URL = 'https://kyavwjhzyrkvcwwtudnp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt5YXZ3amh6eXJrdmN3d3R1ZG5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxOTcyMjAsImV4cCI6MjA4Mjc3MzIyMH0.2jSWz75WEyM-yAmgIawnmlb6HEpMZ0obVd9DnBdDPfY';
        const ENCRYPTION_KEY = 'MiEmpresaAXA_Segura_2025_Cambiar';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;
        let currentEditingId = null;
        let allClients = [];

        // ==================== ENCRIPTACI√ìN ====================
        function encrypt(text) {
            if (!text) return '';
            return CryptoJS.AES.encrypt(text, ENCRYPTION_KEY).toString();
        }

        function decrypt(ciphertext) {
            if (!ciphertext) return '';
            try {
                const bytes = CryptoJS.AES.decrypt(ciphertext, ENCRYPTION_KEY);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                return ciphertext;
            }
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Dashboard cargado');
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                console.log('‚ùå No autenticado');
                window.location.href = 'login.html';
                return;
            }

            currentUser = session.user;
            console.log('‚úÖ Usuario:', currentUser.email);
            document.getElementById('userEmail').textContent = currentUser.email;
            loadClients();
            document.getElementById('clientForm').addEventListener('submit', handleClientSubmit);
        });

        // ==================== LOGOUT ====================
        async function logout() {
            showLoading(true);
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }

        // ==================== CLIENTES ====================
        async function loadClients() {
            console.log('üì• Cargando clientes...');
            const tbody = document.getElementById('clientsTableBody');
            showLoading(true);

            try {
                const { data, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .order('n_cliente', { ascending: true });

                if (error) throw error;

                console.log(`‚úÖ ${data.length} clientes`);
                allClients = data;
                displayClients(data);
            } catch (err) {
                console.error('‚ùå Error:', err);
                showNotification('Error al cargar', 'error');
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #dc3545;">Error al cargar datos. Verifica la configuraci√≥n.</td></tr>';
            } finally {
                showLoading(false);
            }
        }

        function displayClients(clients) {
            const tbody = document.getElementById('clientsTableBody');

            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">No hay clientes. Haz clic en "Nuevo Cliente".</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            clients.forEach(client => {
                const dniLast4 = decrypt(client.dni).slice(-4) || '****';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${client.n_cliente}</strong></td>
                    <td>${client.nombre}</td>
                    <td>${client.apellido}</td>
                    <td>***${dniLast4}</td>
                    <td>${client.poblacion || '-'}</td>
                    <td>${client.n_poliza || '-'}</td>
                    <td>${client.estado_poliza ? '<span class="status-badge status-' + client.estado_poliza.toLowerCase() + '">' + client.estado_poliza + '</span>' : '-'}</td>
                    <td>${client.aseguradora || '-'}</td>
                    <td style="white-space: nowrap;">
                        <button class="btn-edit" onclick="editClient('${client.id}')">‚úèÔ∏è</button>
                        <button class="btn-danger" onclick="deleteClient('${client.id}', '${client.n_cliente}')">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterClients() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allClients.filter(client => {
                return (
                    (client.n_cliente || '').toLowerCase().includes(searchTerm) ||
                    (client.nombre || '').toLowerCase().includes(searchTerm) ||
                    (client.apellido || '').toLowerCase().includes(searchTerm) ||
                    decrypt(client.dni || '').toLowerCase().includes(searchTerm) ||
                    (client.poblacion || '').toLowerCase().includes(searchTerm)
                );
            });
            displayClients(filtered);
        }

        // ==================== MODAL ====================
        function showAddClientModal() {
            currentEditingId = null;
            document.getElementById('modalTitle').textContent = 'Nuevo Cliente';
            document.getElementById('clientForm').reset();
            document.getElementById('clientModal').classList.add('active');
        }

        function closeClientModal() {
            document.getElementById('clientModal').classList.remove('active');
            currentEditingId = null;
        }

        async function editClient(id) {
            showLoading(true);

            try {
                const { data, error } = await supabase.from('clientes').select('*').eq('id', id).single();
                if (error) throw error;

                currentEditingId = id;
                document.getElementById('modalTitle').textContent = 'Editar Cliente';
                document.getElementById('nCliente').value = data.n_cliente || '';
                document.getElementById('nombre').value = data.nombre || '';
                document.getElementById('apellido').value = data.apellido || '';
                document.getElementById('dni').value = decrypt(data.dni) || '';
                document.getElementById('direccion').value = data.direccion || '';
                document.getElementById('codigoPostal').value = data.codigo_postal || '';
                document.getElementById('poblacion').value = data.poblacion || '';
                document.getElementById('fechaNacimiento').value = data.fecha_nacimiento || '';
                document.getElementById('fechaCarnet').value = data.fecha_carnet_conducir || '';
                document.getElementById('nifCif').value = decrypt(data.nif_cif) || '';
                document.getElementById('nPoliza').value = data.n_poliza || '';
                document.getElementById('estadoPoliza').value = data.estado_poliza || '';
                document.getElementById('fechaBaja').value = data.fecha_baja || '';
                document.getElementById('aseguradora').value = data.aseguradora || '';
                document.getElementById('fechaEfecto').value = data.fecha_efecto || '';
                document.getElementById('importeRecibo').value = data.importe_recibo || '';
                document.getElementById('comision').value = data.comision || '';
                document.getElementById('formaPago').value = data.forma_pago || '';
                document.getElementById('nCuenta').value = decrypt(data.n_cuenta) || '';
                document.getElementById('riesgo').value = data.riesgo || '';
                document.getElementById('matricula').value = data.matricula || '';
                document.getElementById('comentarios').value = decrypt(data.comentarios) || '';
                document.getElementById('clientModal').classList.add('active');
            } catch (err) {
                showNotification('Error al cargar', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleClientSubmit(e) {
            e.preventDefault();
            showLoading(true);

            const clientData = {
                n_cliente: document.getElementById('nCliente').value.trim(),
                nombre: document.getElementById('nombre').value.trim(),
                apellido: document.getElementById('apellido').value.trim(),
                dni: encrypt(document.getElementById('dni').value.trim()),
                direccion: document.getElementById('direccion').value.trim(),
                codigo_postal: document.getElementById('codigoPostal').value.trim(),
                poblacion: document.getElementById('poblacion').value.trim(),
                fecha_nacimiento: document.getElementById('fechaNacimiento').value || null,
                fecha_carnet_conducir: document.getElementById('fechaCarnet').value || null,
                nif_cif: encrypt(document.getElementById('nifCif').value.trim()),
                n_poliza: document.getElementById('nPoliza').value.trim(),
                estado_poliza: document.getElementById('estadoPoliza').value,
                fecha_baja: document.getElementById('fechaBaja').value || null,
                aseguradora: document.getElementById('aseguradora').value.trim(),
                fecha_efecto: document.getElementById('fechaEfecto').value || null,
                importe_recibo: parseFloat(document.getElementById('importeRecibo').value) || null,
                comision: parseFloat(document.getElementById('comision').value) || null,
                forma_pago: document.getElementById('formaPago').value,
                n_cuenta: encrypt(document.getElementById('nCuenta').value.trim()),
                riesgo: document.getElementById('riesgo').value,
                matricula: document.getElementById('matricula').value.trim().toUpperCase(),
                comentarios: encrypt(document.getElementById('comentarios').value.trim()),
                user_id: currentUser.id
            };

            try {
                let result;
                if (currentEditingId) {
                    result = await supabase.from('clientes').update(clientData).eq('id', currentEditingId);
                } else {
                    result = await supabase.from('clientes').insert([clientData]);
                }

                if (result.error) throw result.error;

                showNotification(currentEditingId ? '‚úì Actualizado' : '‚úì Creado', 'success');
                closeClientModal();
                loadClients();
            } catch (err) {
                showNotification('Error: ' + err.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteClient(id, nCliente) {
            if (!confirm(`¬øEliminar cliente ${nCliente}?`)) return;
            showLoading(true);

            try {
                const { error } = await supabase.from('clientes').delete().eq('id', id);
                if (error) throw error;
                showNotification('‚úì Eliminado', 'success');
                loadClients();
            } catch (err) {
                showNotification('Error', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ==================== EXCEL ====================
        async function exportToExcel() {
            if (allClients.length === 0) {
                showNotification('No hay datos', 'error');
                return;
            }

            const exportData = allClients.map(c => ({
                'N Cliente': c.n_cliente,
                'Nombre': c.nombre,
                'Apellido': c.apellido,
                'DNI': decrypt(c.dni),
                'Direcci√≥n': c.direccion,
                'C√≥digo Postal': c.codigo_postal,
                'Poblaci√≥n': c.poblacion,
                'Fecha Nacimiento': c.fecha_nacimiento,
                'Fecha Carnet': c.fecha_carnet_conducir,
                'NIF/CIF': decrypt(c.nif_cif),
                'N P√≥liza': c.n_poliza,
                'Estado P√≥liza': c.estado_poliza,
                'Fecha Baja': c.fecha_baja,
                'Aseguradora': c.aseguradora,
                'Fecha Efecto': c.fecha_efecto,
                'Importe Recibo': c.importe_recibo,
                'Comisi√≥n': c.comision,
                'Forma Pago': c.forma_pago,
                'N Cuenta': decrypt(c.n_cuenta),
                'Riesgo': c.riesgo,
                'Matr√≠cula': c.matricula,
                'Comentarios': decrypt(c.comentarios)
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Clientes');
            XLSX.writeFile(wb, `clientes_${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification('‚úì Excel exportado', 'success');
        }

        async function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            showLoading(true);

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                    if (jsonData.length === 0) {
                        showNotification('Archivo vac√≠o', 'error');
                        showLoading(false);
                        return;
                    }

                    let inserted = 0, updated = 0, errors = 0;

                    for (const row of jsonData) {
                        const nCliente = (row['N Cliente'] || row['n_cliente'] || '').toString().trim();
                        if (!nCliente) { errors++; continue; }

                        const { data: existing } = await supabase.from('clientes').select('id').eq('n_cliente', nCliente).single();

                        const clientData = {
                            n_cliente: nCliente,
                            nombre: (row['Nombre'] || '').toString().trim(),
                            apellido: (row['Apellido'] || '').toString().trim(),
                            dni: encrypt((row['DNI'] || '').toString().trim()),
                            direccion: (row['Direcci√≥n'] || row['Direccion'] || '').toString().trim(),
                            codigo_postal: (row['C√≥digo Postal'] || '').toString().trim(),
                            poblacion: (row['Poblaci√≥n'] || row['Poblacion'] || '').toString().trim(),
                            fecha_nacimiento: row['Fecha Nacimiento'] || null,
                            fecha_carnet_conducir: row['Fecha Carnet'] || null,
                            nif_cif: encrypt((row['NIF/CIF'] || '').toString().trim()),
                            n_poliza: (row['N P√≥liza'] || '').toString().trim(),
                            estado_poliza: row['Estado P√≥liza'] || '',
                            fecha_baja: row['Fecha Baja'] || null,
                            aseguradora: (row['Aseguradora'] || '').toString().trim(),
                            fecha_efecto: row['Fecha Efecto'] || null,
                            importe_recibo: parseFloat(row['Importe Recibo'] || 0) || null,
                            comision: parseFloat(row['Comisi√≥n'] || row['Comision'] || 0) || null,
                            forma_pago: row['Forma Pago'] || '',
                            n_cuenta: encrypt((row['N Cuenta'] || '').toString().trim()),
                            riesgo: row['Riesgo'] || '',
                            matricula: (row['Matr√≠cula'] || row['Matricula'] || '').toString().trim(),
                            comentarios: encrypt((row['Comentarios'] || '').toString().trim()),
                            user_id: currentUser.id
                        };

                        if (existing) {
                            const { error } = await supabase.from('clientes').update(clientData).eq('id', existing.id);
                            error ? errors++ : updated++;
                        } else {
                            const { error } = await supabase.from('clientes').insert([clientData]);
                            error ? errors++ : inserted++;
                        }
                    }

                    showNotification(`‚úì ${inserted} nuevos, ${updated} actualizados${errors > 0 ? ', ' + errors + ' errores' : ''}`, errors > 0 ? 'error' : 'success');
                    loadClients();
                } catch (error) {
                    showNotification('Error: ' + error.message, 'error');
                }
                showLoading(false);
            };

            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        // ==================== UTILS ====================
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => notification.classList.remove('show'), 3500);
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('show', show);
        }

        window.onclick = function(event) {
            if (event.target === document.getElementById('clientModal')) {
                closeClientModal();
            }
        }
    </script>
</body>
</html>